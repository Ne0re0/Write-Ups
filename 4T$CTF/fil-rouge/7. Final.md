
# Description

```
Go back to the chat room, The Admin is waiting for you.

The flag follows the format: `4T${<hex_key>}`. The flag for this challenge will be annotated P7
```

# Information from previous steps

**Chat room**
- [https://admin1-aez.hackcorp.net/theadmin0000/e5kVZVjn6XVzYi122RdEF4Jsx1mPEKnL](https://admin1-aez.hackcorp.net/theadmin0000/e5kVZVjn6XVzYi122RdEF4Jsx1mPEKnL "https://admin1-aez.hackcorp.net/theadmin0000/e5kVZVjn6XVzYi122RdEF4Jsx1mPEKnL")

# Messages from the chatbox

```
Connected to the chat server
Admin: Hello there...
Admin: I have a message for you...
Admin: However it seems to be... encrypted..
Admin: And my private key seems corrupted..
```

`private.key`
```pgp
-----BEGIN PRIVATE KEY-----
MAIAQwIAAAAAAAAgBkiG9wAAAAAAAASCAC0wgAkpAAEAAAAAAAAAAAcABvpMABB7
AMrPAIUAAACwAgAJ1gEAAAWuVQAAAAAKsAnAAAikezIAAAAA4AANAAgAoVANAAAE
AGIhTew7ZfBVABBU4AAKXwAAAAAMOBABiUHLTDABkAAOwAR/AC7NLsFgAAcAAAAG
4AAIvFcQAAAA+0oAAAAACwAwALvQAbgd4A6d8ARxjQAQCAAAtwDAAKMxgAgAAASs
AAAVJGAJAAC1AAAJAbUAQACgAAAAAJfgAAAAAARVbgAAB+AAAwAzEAAAAAAAI7AA
AHxQAACVgAlgDe4AQVsuAMAGYlOCgwANa5AAAAEAIAAMAAP9ACAKTgAE0AAG1QAI
uj/0IiAN7QAADC0AAAAAAA8AkAAAzAAHXgAAAAIgAAAAMAAK0AsAu6AAAAAAAABA
AA0wAxUAIAGQC63AAA6wBMAHIAAGEgDVAAAOsAAAkplgCOUAAMAAAGIwAAAAQADA
AAABugAgAAAAAAMA5WZm66AEdgANaonKsA4AC/AAAAAFAAAAAAAAAAABoAEAu1AA
AQAAagAwAA0A0ADwCU6M+zAI/BEgy3kAAFAAAAAF1PAN3k9PM+AMQADjruSjO1rX
/QBRAEAEABAAXX4AAAAAAMUAMAMnAAAAAANAAAoAd+cAAFAA8AbDMoAAAAAAAAAA
xScACXAAAAgwCUQAQAABAAAgCT0AAAIAAAABAAACACm90Dea7bQa/bGYaHuNNbf9
Be5xAg6IGFF7M2dmCnJ5ZcvhdYBXNU1VaFhB/hwIv/h6XlCaXPwh5gt7Ho2qF8AB
fekJebOc5K3+JhJUh706NVSBw7aIaVWyTE2vj9dY72U68LzvoX7hNTu20JSS5L89
x0zgBfxXYr/D3WaUTSrYVEmaBPxZAe8e80rsI6DupFlJqV6/iKovyDWA8JMsnxR8
dVX4TOWtjmB0lYs8VO8TT/5Hr4Ibp/0Kw+QiyS1iwWNyOPZFKBIy9O2YWql3j61x
Lr78F0UYZdShKef1A+1bpD/bkHg7jTHVtnOReePf9/CYB6nJ+TFKPBdrqO6AHi/D
FacY3mCS1mB5KS5Ph9Y4k3XhW0juVnCDTqM885qtGNx7mCR/0BPXimVh9BbDXbtv
NsoFJD4UIVZDsTqfVkltXyxlj+CsgNEWv52MWL4+0zIP1d8rvH6CU7C469elnhLW
ffn18mYCsyZpw0yW4DxeFtG2ujUyMHmSemTHTF7oeC9Xgf0/lhYpcCziZCsm8i03
uqXOZqp75w93heSAwhj9d7fbsLmQe5nxuyTicsCXCr9rRbhyFNHpANVK3jZUHhyY
brk6mxh734o3SNLYzKly2y1uMo8kU4PDm6uGupENu/o6WPEVFRz9DgvxDwRxMbPW
xe80liSvYdjJ1ESb3QuFAoIBAQC+sSt1Vu2iu2w4OCdK3lwfHCaLT6oxjJ9rIekp
0IOgQNDJGEjMzIu9ksXhBeZ2fr3CawSBbfBXZSuuoeddwNbWYJi2CW6a0Sz3Gg4N
yvmQEeD0JYdv3I0Fslf7Ld8RoF3wkEiYu98pk4y1RRrXRaSb1x0pNMdl31/Q55R0
QLnxPlriYeofzcoE4xXJScm3w09UJFn5KZLPVmtdKL2SSKFtHxQ0QorfWTfFFMRf
c80dfdN/+zaP6qfpvqi4BUthEqYl0cZQQuPNyYU1NLgFyZGxSA3p3oWZ3AyX4aQt
Inoh74r7gO9p/2LlaTDp22+CJUJuMJFsZqBAkJmF9JemMg/NAoIBAQDO3EhTufdY
z8Bclpqe80v3U0uwygf0DXV0A4iLvL5yzUOZWfGanqNartmvPV2z+JRqbv19zM7b
uTWNgHVGR5Aj7dyyTmq1R2zE5Lm/9ZpnJobOhGJ7WaQsTIGcMYB3JIV4LvDhRtzH
NKb+sgmDWqfWZxBgJ8cv2vvwr5zeS57JxN0MvmxLb5Ko34Kktq4aZztxHsJpYDFQ
e7D2YuLiFdHOFSc9C0aXdSuw8mE2edBuxjBO4I/7Tji/zUeJuOxI82n+AWHsFAqB
G3RO9VXYIiGe1dkNTMCyGstLVjjdOyXby0xXGBUKH+E1CB0hakCCguUPPF1XQ4fZ
9M/Vi+YTzm5zAoIBAARXXDkAAAADAAAAAAAAAJAAsADgDQAwAAAAAA7QAGAAAAM9
nkAATQAAAADbAAAOEAAOAADQDABAAAAiAAYAAAsAAAJ1HIOBAJgAgAFQAAAAAAAA
Ybj2AG+gAAwAAAfnYAwbTADNAAADAKADyQCgAA6XAADxCAAAAMVcwAAACMYAAAAG
cgAACU4AAD/AAjAAvoAH2kSAAMAAAAAABlPSMAAAAABAAIAAAAEAAAAACmAAAA8q
1OAJAAAJ2gBwCWAAWwAAAAAAAAAAAAAAAEACeAAA1UxAAKDsAIAAAME1AAACDZP0
AHAORUAAsAAHAA3k8AAG8Nia7YMAALAAAADQAPEAggAAALqC3yuulxgaaSSSHeOH
Fk1vauWBo14m7Gmn7eugSE8WSAbyk+aHdl4DHP7l46CrVpYIcMKGcVSnT2PAGP0+
9PWQN9cE4S2FsspsOBaeCZNLp2x47JqvHllaudnswBmscjMEj+dujw2FqbQnLnCi
woWL87Xe57d8SICgtl2v7QGbYHtnDhmOBbwBmreMhroDrhK2Wy/LrWsVu17Llimm
5r5bUD+39PQGj1hBkekeOBJI27Giw+8gfgZhvkis1U6JOl3tPS8werAh4uJ2TepM
C+g8hDF7rJppkjbhDPBbrizYxoIYko/IYrQAFtPUC0ohXwo3sSlHGCwqkWHHe7EM
BYUAAAABAJFJHkIkfPEKxnPKhjLUh2ST1PWprEJBUfVodT9dK116Y52YXjnBFS0J
hKR5Q7F0P18yGx9xvpoCVYzfcoo4x9qTyyW5h+P7MF9QhVNgHJLFzJCoCTZAJqYO
SE2bJQwki1LcOJp4d+TAY7GM82bG5hoJqdGgXv1JlmOQUXhfx3l4K9lwk9DxCzBp
qBjBUHYOUETStns8VQtveqK8FZ9Zl4TTGR918bxEgwkWgtGay24MV6wbFrb7r1Dc
CIUk8iy/A5MD+H+yTIwKr9DOH4uByy0B98w42AyojGVn5YBqA3lhyU+iSqHAXou5
YdJGr89Pvy1ywLDPxKudyjg1ust+Ipc=
-----END PRIVATE KEY-----
```

`message.enc`
```
hnSRdgBJZ4/nx5rFi+TthovhhDfdvB9vYwhlZyeD6QuGsw499MQ8MMz0dy/iknxay7rl94toYY0l 
NiSmINmwQcrulMijOaL5gR+fk3fsnfm1wd+qKB3TfQ4sGAuYMLWIwhUr+2aQX/BXWxW7fRqviswa 
GBopbB3uqFf7ulVPczymgO740c/QaHPVKcQaYxVOWMyeIcNsJ+HcGiLu2fPYZh/YRJX4iKqlQos9 
AQDS/aGgtNCnlFlnV5RiocxjTeWPeYLqUFX7BNN+jsldhErTTFwUxJCV27DwSOfPmyRbX0A1G++W 
uPBvWIG0Tz+j/6/T6Wr102dCu3LaGNRv9xh8/LnzajVWsLfFi3lwi4JeZvATIDxiM+vqX8y9Z3YC 
xdc9F2DiYR+dguinjWDOPFDgyhCE7+5RO/bFCKUvnaMx7ABb+THbn9VNrW2aokY7KgEmra18+xUy 
AGtAcWn5qRmK5whZymdYN6da0NJvpyTqbAD6Gk/0WBVeGAplgX/0L4IeAqlqw9mHxDRn0LMYFTTm 
e5qWvdIIQGEMMdUCWL0QegQ9m0UwcUv4Uj7FzZ/PvISn2IhwSSKfhBMzCBYIIVQgVWDRWQajz1wW 
WiDqCgB9QT4PuHV1+Ch6XsDp03nqk5pE4OTWwswcPjOrbzxC4LTf7ktrOFVx+JAfUCuTx2UBzoA=
```

# Write Up

Basically, we have to retrieve `p`, `q` and `e` from the given RSA private key to generate a valid one.

I found this repo that strongly helped me : https://github.com/OwenK2/Fall-2021-NCL-Corrupted-PEM-Write-Up

Based on it, I created an example RSA key with 
```bash
openssl genrsa -out test.pem 4096
```

And I extracted values from the corrupted key comparing it to the valid one using the script in the repo.
```python
import base64

# Read the example key
with open("test.pem","r") as f:
    test_content = f.read().splitlines()[1:-1]
    test_content = ''.join(test_content)
    testpem = base64.b64decode(test_content)
    print(testpem)

# Read the corrupted key
with open("private.key","r") as f:
    corrupted_content = f.read().splitlines()[1:-1]
    corrupted_content = ''.join(corrupted_content)
    pem = base64.b64decode(corrupted_content)
    print(pem)


chunks = []
i = 0
while i < len(testpem):
	if testpem[i] == 0x02:
		hl = 0
		length = 0
		# Read the valid key to find chunk locations
		if (testpem[i+1] & 0x80) > 0:
			hl = testpem[i+1] & 0x3F
			length = int.from_bytes(testpem[i+2:i+hl+2], byteorder='big')
		else:
			length = testpem[i+1] & 0x3F
		chunks.append((i+2+hl, i+2+hl+length))
		# Print chunks from the corrupted key
		print(order[len(chunks)-2] + " : " + pem[i+2+hl:i+2+hl+length].hex())
		print()
		i += hl + length + 2
	else:
		i += 1

# Print every number found in the RSA key
print(chunks)
```

Knowing the order of number

```
RSAPrivateKey ::= SEQUENCE {
	version           Version,
	modulus           INTEGER,  -- n
	publicExponent    INTEGER,  -- e
	privateExponent   INTEGER,  -- d
	prime1            INTEGER,  -- p
	prime2            INTEGER,  -- q
	exponent1         INTEGER,  -- d mod (p-1)
	exponent2         INTEGER,  -- d mod (q-1)
	coefficient       INTEGER,  -- (inverse of q) mod p
	otherPrimeInfos   OtherPrimeInfos OPTIONAL
}
```

We can easily find `p`,`q` and `e` from the output
```python
p = 0x00beb12b7556eda2bb6c3838274ade5c1f1c268b4faa318c9f6b21e929d083a040d0c91848cccc8bbd92c5e105e6767ebdc26b04816df057652baea1e75dc0d6d66098b6096e9ad12cf71a0e0dcaf99011e0f425876fdc8d05b257fb2ddf11a05df0904898bbdf29938cb5451ad745a49bd71d2934c765df5fd0e7947440b9f13e5ae261ea1fcdca04e315c949c9b7c34f542459f92992cf566b5d28bd9248a16d1f1434428adf5937c514c45f73cd1d7dd37ffb368feaa7e9bea8b8054b6112a625d1c65042e3cdc9853534b805c991b1480de9de8599dc0c97e1a42d227a21ef8afb80ef69ff62e56930e9db6f8225426e30916c66a040909985f497a6320fcd
q = 0x00cedc4853b9f758cfc05c969a9ef34bf7534bb0ca07f40d757403888bbcbe72cd439959f19a9ea35aaed9af3d5db3f8946a6efd7dcccedbb9358d807546479023eddcb24e6ab5476cc4e4b9bff59a672686ce84627b59a42c4c819c3180772485782ef0e146dcc734a6feb209835aa7d667106027c72fdafbf0af9cde4b9ec9c4dd0cbe6c4b6f92a8df82a4b6ae1a673b711ec2696031507bb0f662e2e215d1ce15273d0b4697752bb0f2613679d06ec6304ee08ffb4e38bfcd4789b8ec48f369fe0161ec140a811b744ef555d822219ed5d90d4cc0b21acb4b5638dd3b25dbcb4c5718150a1fe135081d216a408282e50f3c5d574387d9f4cfd58be613ce6e73
e = 0x10001
```

Now that we have retrieved those private information we can rebuild a valid RSA key
```python
from cryptography.hazmat.primitives.asymmetric import rsa
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.backends import default_backend
from sympy import mod_inverse

p = 0x00beb12b7556eda2bb6c3838274ade5c1f1c268b4faa318c9f6b21e929d083a040d0c91848cccc8bbd92c5e105e6767ebdc26b04816df057652baea1e75dc0d6d66098b6096e9ad12cf71a0e0dcaf99011e0f425876fdc8d05b257fb2ddf11a05df0904898bbdf29938cb5451ad745a49bd71d2934c765df5fd0e7947440b9f13e5ae261ea1fcdca04e315c949c9b7c34f542459f92992cf566b5d28bd9248a16d1f1434428adf5937c514c45f73cd1d7dd37ffb368feaa7e9bea8b8054b6112a625d1c65042e3cdc9853534b805c991b1480de9de8599dc0c97e1a42d227a21ef8afb80ef69ff62e56930e9db6f8225426e30916c66a040909985f497a6320fcd
q = 0x00cedc4853b9f758cfc05c969a9ef34bf7534bb0ca07f40d757403888bbcbe72cd439959f19a9ea35aaed9af3d5db3f8946a6efd7dcccedbb9358d807546479023eddcb24e6ab5476cc4e4b9bff59a672686ce84627b59a42c4c819c3180772485782ef0e146dcc734a6feb209835aa7d667106027c72fdafbf0af9cde4b9ec9c4dd0cbe6c4b6f92a8df82a4b6ae1a673b711ec2696031507bb0f662e2e215d1ce15273d0b4697752bb0f2613679d06ec6304ee08ffb4e38bfcd4789b8ec48f369fe0161ec140a811b744ef555d822219ed5d90d4cc0b21acb4b5638dd3b25dbcb4c5718150a1fe135081d216a408282e50f3c5d574387d9f4cfd58be613ce6e73
e = 0x10001

def generate_private_key_pem(p, q, e):
    # Compute n, phi(n) and d
    n = p * q
    phi_n = (p - 1) * (q - 1)
    d = mod_inverse(e, phi_n)

    # Build the RSA key
    private_key = rsa.RSAPrivateNumbers(
        p=p,
        q=q,
        d=d,
        dmp1=d % (p - 1),
        dmq1=d % (q - 1),
        iqmp=mod_inverse(q, p),
        public_numbers=rsa.RSAPublicNumbers(e=e, n=n)
    ).private_key(default_backend())

    # Export the key to PEM format
    private_key_pem = private_key.private_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PrivateFormat.PKCS8,
        encryption_algorithm=serialization.NoEncryption()
    )

    return private_key_pem


# Generate the private key and write it to a file
private_key_pem = generate_private_key_pem(p, q, e)

with open("retrieved.pem","wb") as f :
    f.write(private_key_pem)
```

As openssl works with binary files and not base64, we have to decode the content of the encrypted message
```bash
cat message.enc | base64 -d > message.enc.bin
```

We can decrypt the message with out new key.
```bash
openssl pkeyutl -decrypt -inkey retrieved.pem -in message.enc.bin
```

Here is the message
```
Congratulations, you can now join our Organization !

Here's your final key : 4T${57dcd899a8c44f5764aaa833a3859a07} !
```

# Flag

`4T${57dcd899a8c44f5764aaa833a3859a07}`

